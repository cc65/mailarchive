<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
                      "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
<title>cc65 mailing list archive: Re: compiler bug?</title>
<meta name="Author" content="Ullrich von Bassewitz (uz_at_musoftware.de)">
<meta name="Subject" content="Re: compiler bug?">
</head>
<body bgcolor="#FFFFFF" text="#000000">
<h1>Re: compiler bug?</h1>
<!-- received="Fri Jul  9 19:52:25 1999" -->
<!-- isoreceived="19990709175225" -->
<!-- sent="Fri, 9 Jul 1999 19:42:24 +0200" -->
<!-- isosent="19990709174224" -->
<!-- name="Ullrich von Bassewitz" -->
<!-- email="uz_at_musoftware.de" -->
<!-- subject="Re: compiler bug?" -->
<!-- id="99070919520700.00637@wuschel.musoftware.de" -->
<!-- inreplyto="199907091709.TAA07823@starship.cling.gu.se" -->
<!-- expires="-1" -->
<div align="center">
<table border="2" width="100%">
<tr>
<th><a href="date.html">Date view</a></th>
<th><a href="index.html">Thread view</a></th>
<th><a href="subject.html">Subject view</a></th>
</tr>
</table>
</div>
<p>
<strong>From:</strong> Ullrich von Bassewitz (<a href="mailto:uz_at_musoftware.de?Subject=Re:%20compiler%20bug?"><em>uz_at_musoftware.de</em></a>)<br>
<strong>Date:</strong> 1999-07-09 19:42:24
<p>
<!-- next="start" -->
<ul>
<li><strong>Next message:</strong> <a href="0994.html">MagerValp: "Re: compiler bug?"</a>
<li><strong>Previous message:</strong> <a href="0992.html">MagerValp: "compiler bug?"</a>
<li><strong>In reply to:</strong> <a href="0992.html">MagerValp: "compiler bug?"</a>
<!-- nextthread="start" -->
<li><strong>Next in thread:</strong> <a href="0994.html">MagerValp: "Re: compiler bug?"</a>
<!-- reply="end" -->
</ul>
<hr noshade><p>
<!-- body="start" -->
<pre>
On Fri, 09 Jul 1999, you wrote:
&gt;I think something's broken in cc65 -- x[y&gt;&gt;n] doesn't seem to work the
&gt;way it should.

You are right. When addressing local arrays, the code generator omits a &quot;clc&quot;
instruction when calculating the effective address on the stack so the wrong
slot is accessed if the carry is set at that time. The problem is not in the
shift operation, but in the stack access. Maybe the shift operation gives a
high probability for the bug being triggered, since it often returns with
carry set.

Here's a patch for the compiler:

*** codegen.c~	Sat May 15 14:28:26 1999
--- codegen.c	Fri Jul  9 19:39:49 1999
***************
*** 1674,1681 ****
      if (offs != 0) {
  	/* We cannot address more then 256 bytes of locals anyway */
  	CheckLocalOffs (offs);
! 	out (&quot;\tadc\t#$%02X\n&quot;
! 	     &quot;\tbcc\t*+3\n&quot;
  	     &quot;\tinx\n&quot;,
  	     offs &amp; 0xFF);
  	/* Invalidate X */
--- 1674,1682 ----
      if (offs != 0) {
  	/* We cannot address more then 256 bytes of locals anyway */
  	CheckLocalOffs (offs);
! 	out (&quot;\tclc\n&quot;
! 	     &quot;\tadc\t#$%02X\n&quot;
! 	     &quot;\tbcc\t*+4\n&quot;	/* Do also skip the CLC insn below */
  	     &quot;\tinx\n&quot;,
  	     offs &amp; 0xFF);
  	/* Invalidate X */


Thanks for pointing out this problem!

Regards


	Uz


--
Ullrich von Bassewitz                                  <a href="mailto:uz_at_musoftware.de?Subject=Re:%20compiler%20bug?">uz_at_musoftware.de</a>
----------------------------------------------------------------------
To unsubscribe from the list send mail to <a href="mailto:majordomo_at_musoftware.de?Subject=Re:%20compiler%20bug?">majordomo_at_musoftware.de</a> with
the string &quot;unsubscribe cc65&quot; in the body(!) of the mail.
</pre>
<p><!-- body="end" -->
<hr noshade>
<ul>
<!-- next="start" -->
<li><strong>Next message:</strong> <a href="0994.html">MagerValp: "Re: compiler bug?"</a>
<li><strong>Previous message:</strong> <a href="0992.html">MagerValp: "compiler bug?"</a>
<li><strong>In reply to:</strong> <a href="0992.html">MagerValp: "compiler bug?"</a>
<!-- nextthread="start" -->
<li><strong>Next in thread:</strong> <a href="0994.html">MagerValp: "Re: compiler bug?"</a>
<!-- reply="end" -->
</ul>
<div align="center">
<table border="2" width="100%">
<tr>
<th><a href="date.html">Date view</a></th>
<th><a href="index.html">Thread view</a></th>
<th><a href="subject.html">Subject view</a></th>
</tr>
</table>
</div>
<!-- trailer="footer" -->
<p>
<small>
<em>
This archive was generated by <a href="http://www.hypermail.org/">hypermail 2.1.3</a> 
: <em>2001-12-14 22:05:44 CET</em>
</em>
</small>
</body>
</html>
