<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
                      "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
<title>cc65 mailing list archive: [cc65] Bug description</title>
<meta name="Author" content="Ullrich von Bassewitz (uz_at_musoftware.de)">
<meta name="Subject" content="[cc65] Bug description">
</head>
<body bgcolor="#FFFFFF" text="#000000">
<h1>[cc65] Bug description</h1>
<!-- received="Thu Jan  6 22:48:06 2000" -->
<!-- isoreceived="20000106214806" -->
<!-- sent="Thu, 6 Jan 2000 22:47:44 +0100 (CET)" -->
<!-- isosent="20000106214744" -->
<!-- name="Ullrich von Bassewitz" -->
<!-- email="uz_at_musoftware.de" -->
<!-- subject="[cc65] Bug description" -->
<!-- id="200001062147.WAA12192@trixie.musoftware.de" -->
<!-- expires="-1" -->
<div align="center">
<table border="2" width="100%">
<tr>
<th><a href="date.html">Date view</a></th>
<th><a href="index.html">Thread view</a></th>
<th><a href="subject.html">Subject view</a></th>
</tr>
</table>
</div>
<p>
<strong>From:</strong> Ullrich von Bassewitz (<a href="mailto:uz_at_musoftware.de?Subject=Re:%20[cc65]%20Bug%20description"><em>uz_at_musoftware.de</em></a>)<br>
<strong>Date:</strong> 2000-01-06 22:47:44
<p>
<!-- next="start" -->
<ul>
<li><strong>Next message:</strong> <a href="0004.html">Ullrich von Bassewitz: "[cc65] test suite"</a>
<li><strong>Previous message:</strong> <a href="0002.html">Ullrich von Bassewitz: "[cc65] Version 2.3.1 is out"</a>
<!-- nextthread="start" -->
<!-- reply="end" -->
</ul>
<hr noshade><p>
<!-- body="start" -->
<pre>
Keith asked me about the integer compare bug. Since this may be
interesting for more people here is an explanation.

When comparing values, the compiler generated the following code:

	int a;
	if (a &gt; 0x1FF) ...
			      

	lda	_a
	ldx	_a+1
	cpx	#$01
	bne	*+4
	cmp	#$FF
	jsr	boolgt

The subroutine evaluates the N and Z flags assuming a signed compare
greater than and loads a boolean value. The problem is, that the
generated code is wrong for signed values: If the high byte of both
values is equal, the low byte must be compared, but this must be an
unsigned compare, not a signed one. That means, for the high byte, the Z
and N flags have to be evaluated, but for the low byte the Z and C flags.
As a consequence, the result of the compare was wrong for specific
values. These values have the same high byte, and

      	(lhs - rhs) &gt;= $80

So the N flag was set and evaluated in the wrong way.

Unfortunately, the same code was used in the runtime library, and the
peephole optimizer had several routines looking for this and similar
pieces of code, since in many cases the code may be simplified, or the
call to the subroutine may be removed.

If you look at the code, it seems to be silly, how one can overlook the
problem. And I did not only overlook it, I changed the old, slow but
working code against a faster non-working one.

The current solution is to fix the subroutine in the runtime library, and
use it for signed values instead of inlining the code. There are probably
solutions that produce faster code, but I was afraid to break anything,
so I took the easiest way out.

Regards


	Uz


--
Ullrich von Bassewitz                                  <a href="mailto:uz_at_musoftware.de?Subject=Re:%20[cc65]%20Bug%20description">uz_at_musoftware.de</a>
----------------------------------------------------------------------
To unsubscribe from the list send mail to <a href="mailto:majordomo_at_musoftware.de?Subject=Re:%20[cc65]%20Bug%20description">majordomo_at_musoftware.de</a> with
the string &quot;unsubscribe cc65&quot; in the body(!) of the mail.
</pre>
<p><!-- body="end" -->
<hr noshade>
<ul>
<!-- next="start" -->
<li><strong>Next message:</strong> <a href="0004.html">Ullrich von Bassewitz: "[cc65] test suite"</a>
<li><strong>Previous message:</strong> <a href="0002.html">Ullrich von Bassewitz: "[cc65] Version 2.3.1 is out"</a>
<!-- nextthread="start" -->
<!-- reply="end" -->
</ul>
<div align="center">
<table border="2" width="100%">
<tr>
<th><a href="date.html">Date view</a></th>
<th><a href="index.html">Thread view</a></th>
<th><a href="subject.html">Subject view</a></th>
</tr>
</table>
</div>
<!-- trailer="footer" -->
<p>
<small>
<em>
This archive was generated by <a href="http://www.hypermail.org/">hypermail 2.1.3</a> 
: <em>2001-12-14 22:05:35 CET</em>
</em>
</small>
</body>
</html>
