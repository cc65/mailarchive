<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
                      "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
<title>cc65 mailing list archive: Re: [cc65] Interrupts and break</title>
<meta name="Author" content="Ullrich von Bassewitz (uz_at_musoftware.de)">
<meta name="Subject" content="Re: [cc65] Interrupts and break">
</head>
<body bgcolor="#FFFFFF" text="#000000">
<h1>Re: [cc65] Interrupts and break</h1>
<!-- received="Sun Sep 30 20:01:23 2001" -->
<!-- isoreceived="20010930180123" -->
<!-- sent="Sun, 30 Sep 2001 20:01:25 +0200" -->
<!-- isosent="20010930180125" -->
<!-- name="Ullrich von Bassewitz" -->
<!-- email="uz_at_musoftware.de" -->
<!-- subject="Re: [cc65] Interrupts and break" -->
<!-- id="20010930200125.A6345@trixie.musoftware.de" -->
<!-- inreplyto="3BB74D40.299C582C@student.liu.se" -->
<!-- expires="-1" -->
<div align="center">
<table border="2" width="100%">
<tr>
<th><a href="date.html">Date view</a></th>
<th><a href="index.html">Thread view</a></th>
<th><a href="subject.html">Subject view</a></th>
</tr>
</table>
</div>
<p>
<strong>From:</strong> Ullrich von Bassewitz (<a href="mailto:uz_at_musoftware.de?Subject=Re:%20[cc65]%20Interrupts%20and%20break"><em>uz_at_musoftware.de</em></a>)<br>
<strong>Date:</strong> 2001-09-30 20:01:25
<p>
<!-- next="start" -->
<ul>
<li><strong>Next message:</strong> <a href="0765.html">Adam Dunkels: "Re: [cc65] Interrupts and break"</a>
<li><strong>Previous message:</strong> <a href="0763.html">groepaz: "Re: [cc65] Interrupts and break"</a>
<li><strong>In reply to:</strong> <a href="0762.html">Daniel Berntsson: "[cc65] Interrupts and break"</a>
<!-- nextthread="start" -->
<li><strong>Next in thread:</strong> <a href="../2001-10/0767.html">Daniel Berntsson: "Re: [cc65] Interrupts and break"</a>
<!-- reply="end" -->
</ul>
<hr noshade><p>
<!-- body="start" -->
<pre>
Hi!

On Sun, Sep 30, 2001 at 06:50:08PM +0200, Daniel Berntsson wrote:
&gt; I've tried to use a timer interrupt to check the joysticks and update
&gt; some structs and sprites. (on the c64, or well, vice) Unfortunately, as
&gt; soon as I try to use any not totally trivial functions in my (probably
&gt; wrongly set up) interrupt handler the program crashes or goes weird. I
&gt; haven't found any mentions of how to do interrupts in C or cc65 and no
&gt; good examples anywhere. It would be nice if someone could tell me or
&gt; point me to the correct cc65 way of doing this.

As any non trivial 6502 program, the code generated by cc65 makes use of the
zero page. Zero page locations are used for the argument stack, and as
temporary storage for most of the runtime support functions. So when writing
interrupt handlers in C, it is necessary to save the CPU registers plus these
zero page locations. In addition to that, the functions that manipulate the
stack pointer are not reentrant, so you have to setup a separate stack for the
interrupt handler.

As you can see, it cannot be done without some assembler code. For many
applications, the wrapper code is more than what has to be done in the
interrupt handler itself, so I do usually suggest to think about writing the
interrupt handler in assembler (provided it is rather short). If you don't
want to do this for some reason or another, you may want to have a look at the
break handler. It contains all code that would also be needed for an interrupt
handler (saving registers and zero page locations, calling a C function).

&gt; And another thing; When the brk_handler function returns, it returns to
&gt; the BRK instruction and not the next one. So it will be called again and
&gt; again and.. Is this really how it is supposed to be?

Yes, it is supposed to work like that. The break handler was thought to be
part of a debugger (probably the most common usage). A debugger uses the BRK
instruction to insert breakpoints, and - if a break occurs - it needs the
address of the BRK instruction to locate the breakpoint in the active
breakpoint list.

Because the break handler does not know, what to skip (just the break? the
instruction that was replaced by the break? the two bytes that are skipped by
the 6502 on occurrance of a break?), it is best to not skip anything. Having
the PC point to the break instruction itself, the application (which has more
knowledge) can handle the situation.

Regards


        Uz


-- 
Ullrich von Bassewitz                                  <a href="mailto:uz_at_musoftware.de?Subject=Re:%20[cc65]%20Interrupts%20and%20break">uz_at_musoftware.de</a>
----------------------------------------------------------------------
To unsubscribe from the list send mail to <a href="mailto:majordomo_at_musoftware.de?Subject=Re:%20[cc65]%20Interrupts%20and%20break">majordomo_at_musoftware.de</a> with
the string &quot;unsubscribe cc65&quot; in the body(!) of the mail.
</pre>
<p><!-- body="end" -->
<hr noshade>
<ul>
<!-- next="start" -->
<li><strong>Next message:</strong> <a href="0765.html">Adam Dunkels: "Re: [cc65] Interrupts and break"</a>
<li><strong>Previous message:</strong> <a href="0763.html">groepaz: "Re: [cc65] Interrupts and break"</a>
<li><strong>In reply to:</strong> <a href="0762.html">Daniel Berntsson: "[cc65] Interrupts and break"</a>
<!-- nextthread="start" -->
<li><strong>Next in thread:</strong> <a href="../2001-10/0767.html">Daniel Berntsson: "Re: [cc65] Interrupts and break"</a>
<!-- reply="end" -->
</ul>
<div align="center">
<table border="2" width="100%">
<tr>
<th><a href="date.html">Date view</a></th>
<th><a href="index.html">Thread view</a></th>
<th><a href="subject.html">Subject view</a></th>
</tr>
</table>
</div>
<!-- trailer="footer" -->
<p>
<small>
<em>
This archive was generated by <a href="http://www.hypermail.org/">hypermail 2.1.3</a> 
: <em>2001-12-14 22:05:42 CET</em>
</em>
</small>
</body>
</html>
