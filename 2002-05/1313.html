<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
                      "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
<title>cc65 mailing list archive: [cc65] Atari File I/O again</title>
<meta name="Author" content="Shawn Jefferson (sjefferson_at_sd62.bc.ca)">
<meta name="Subject" content="[cc65] Atari File I/O again">
</head>
<body bgcolor="#FFFFFF" text="#000000">
<h1>[cc65] Atari File I/O again</h1>
<!-- received="Tue May 14 21:37:33 2002" -->
<!-- isoreceived="20020514193733" -->
<!-- sent="Tue, 14 May 2002 12:36:57 -0700" -->
<!-- isosent="20020514193657" -->
<!-- name="Shawn Jefferson" -->
<!-- email="sjefferson_at_sd62.bc.ca" -->
<!-- subject="[cc65] Atari File I/O again" -->
<!-- id="sce1050a.071@gwmail.sd62.bc.ca" -->
<!-- expires="-1" -->
<div align="center">
<table border="2" width="100%">
<tr>
<th><a href="date.html">Date view</a></th>
<th><a href="index.html">Thread view</a></th>
<th><a href="subject.html">Subject view</a></th>
</tr>
</table>
</div>
<p>
<strong>From:</strong> Shawn Jefferson (<a href="mailto:sjefferson_at_sd62.bc.ca?Subject=Re:%20[cc65]%20Atari%20File%20I/O%20again"><em>sjefferson_at_sd62.bc.ca</em></a>)<br>
<strong>Date:</strong> 2002-05-14 21:36:57
<p>
<!-- next="start" -->
<ul>
<li><strong>Previous message:</strong> <a href="1312.html">Dominique Biesmans: "Re: [cc65] Problem with kbhit()?"</a>
<!-- nextthread="start" -->
<li><strong>Next in thread:</strong> <a href="1317.html">Ullrich von Bassewitz: "Re: [cc65] Atari File I/O again"</a>
<li><strong>Reply:</strong> <a href="1317.html">Ullrich von Bassewitz: "Re: [cc65] Atari File I/O again"</a>
<li><strong>Reply:</strong> <a href="1324.html">Christian Groessler: "Re: [cc65] Atari File I/O again"</a>
<li><strong>Reply:</strong> <a href="1325.html">Shawn Jefferson: "Re: [cc65] Atari File I/O again"</a>
<!-- reply="end" -->
</ul>
<hr noshade><p>
<!-- body="start" -->
<pre>
Hi there,

I was playing around with the Atari file routines a little bit more and I don't think that feof is working properly.

I created a test program that:
1. creates file, writes into it, closes it.
2. opens the file for r/w, reads until feof, then writes to the file.

However, the program doesn't signal FEOF ever, and the the program just keeps reading from the file past the end until the emulator locks up or I hit RESET.

Here is the code for read.s in the atari library:

_read:  jsr     __rwsetup       ; do common setup for read and write
        beq     done            ; if size 0, it's a no-op
        cpx     #$FF            ; invalid iocb?
        beq     _inviocb
        lda     #GETCHR         ; iocb command code
        sta     ICCOM,x
        jsr     CIOV            ; read it
        bpl     done
        cpy     #EOFERR         ; eof is treated specially
        beq     done
        jmp     __do_oserror    ; update errno

done:   lda     ICBLL,x         ; buf len lo
        pha                     ; save
        lda     ICBLH,x         ; get buf len hi
        tax                     ; to X
        lda     #0
        sta     __oserror       ; clear system dependend error code
        pla                     ; get buf len lo
        rts

_inviocb:
        jmp     __inviocb


I took a look into the source, and I don't fully understand it, but shouldn't read.s in the atari library be setting a flag for EOF in the file pointer structure somehow, instead of just BEQing to done?

Thanks,
Shawn


----------------------------------------------------------------------
To unsubscribe from the list send mail to <a href="mailto:majordomo_at_musoftware.de?Subject=Re:%20[cc65]%20Atari%20File%20I/O%20again">majordomo_at_musoftware.de</a> with
the string &quot;unsubscribe cc65&quot; in the body(!) of the mail.
</pre>
<p><!-- body="end" -->
<hr noshade>
<ul>
<!-- next="start" -->
<li><strong>Previous message:</strong> <a href="1312.html">Dominique Biesmans: "Re: [cc65] Problem with kbhit()?"</a>
<!-- nextthread="start" -->
<li><strong>Next in thread:</strong> <a href="1317.html">Ullrich von Bassewitz: "Re: [cc65] Atari File I/O again"</a>
<li><strong>Reply:</strong> <a href="1317.html">Ullrich von Bassewitz: "Re: [cc65] Atari File I/O again"</a>
<li><strong>Reply:</strong> <a href="1324.html">Christian Groessler: "Re: [cc65] Atari File I/O again"</a>
<li><strong>Reply:</strong> <a href="1325.html">Shawn Jefferson: "Re: [cc65] Atari File I/O again"</a>
<!-- reply="end" -->
</ul>
<div align="center">
<table border="2" width="100%">
<tr>
<th><a href="date.html">Date view</a></th>
<th><a href="index.html">Thread view</a></th>
<th><a href="subject.html">Subject view</a></th>
</tr>
</table>
</div>
<!-- trailer="footer" -->
<p>
<small>
<em>
This archive was generated by <a href="http://www.hypermail.org/">hypermail 2.1.3</a> 
: <em>2002-05-14 21:37:46 CEST</em>
</em>
</small>
</body>
</html>
