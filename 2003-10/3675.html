<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
                      "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
<title>cc65 mailing list archive: Re: [cc65] Platform specific docs</title>
<meta name="Author" content="Ullrich von Bassewitz (uz_at_musoftware.de)">
<meta name="Subject" content="Re: [cc65] Platform specific docs">
</head>
<body bgcolor="#FFFFFF" text="#000000">
<h1>Re: [cc65] Platform specific docs</h1>
<!-- received="Tue Oct 28 21:05:45 2003" -->
<!-- isoreceived="20031028200545" -->
<!-- sent="Tue, 28 Oct 2003 21:05:40 +0100" -->
<!-- isosent="20031028200540" -->
<!-- name="Ullrich von Bassewitz" -->
<!-- email="uz_at_musoftware.de" -->
<!-- subject="Re: [cc65] Platform specific docs" -->
<!-- id="20031028200540.GA22628@trixie.musoftware.de" -->
<!-- inreplyto="t6htpvcp6mg1l3p9jdtdtsqfk1j6d5m5g2@4ax.com" -->
<!-- expires="-1" -->
<div align="center">
<table border="2" width="100%">
<tr>
<th><a href="date.html">Date view</a></th>
<th><a href="index.html">Thread view</a></th>
<th><a href="subject.html">Subject view</a></th>
</tr>
</table>
</div>
<p>
<strong>From:</strong> Ullrich von Bassewitz (<a href="mailto:uz_at_musoftware.de?Subject=Re:%20[cc65]%20Platform%20specific%20docs"><em>uz_at_musoftware.de</em></a>)<br>
<strong>Date:</strong> 2003-10-28 21:05:40
<p>
<!-- next="start" -->
<ul>
<li><strong>Previous message:</strong> <a href="3674.html">Shawn Jefferson: "Re: [cc65] Platform specific docs"</a>
<li><strong>In reply to:</strong> <a href="3674.html">Shawn Jefferson: "Re: [cc65] Platform specific docs"</a>
<!-- nextthread="start" -->
<li><strong>Next in thread:</strong> <a href="3676.html">Shawn Jefferson: "Re: [cc65] Platform specific docs"</a>
<li><strong>Next in thread:</strong> <a href="../2003-09/3446.html">Groepaz: "Re: [cc65] Platform specific docs"</a>
<!-- reply="end" -->
</ul>
<hr noshade><p>
<!-- body="start" -->
<pre>
On Tue, Oct 28, 2003 at 11:37:15AM -0800, Shawn Jefferson wrote:
&gt; Doh!  I think I see what you mean.  the heapend initialization doesn't
&gt; really do anything... and the initheap is assigning the heapend to
&gt; just below the stack, not really in the BSS segment at all...

Correct, but ...

&gt; Hmmm, another question then, if the above is correct, will moving the
&gt; BSS segment on the Atari platform cause problems with the heap?  Since
&gt; heaporg and heapptr are assigned values from the BSS segment, or does
&gt; these variables get changed somewhere else?

... heaporg and heapptr are preset with values calculated from the BSS
segment. If you move the stack somewhere else, heapend will also get moved,
because it is calculated from the stack pointer. So the end of the heap does
no longer relate to the start, and things go wrong. This is what I meant with
&quot;The current implementation of the heap assumes that the stack is located at
the end of the BSS segment&quot;.

The memory setup for most platforms (including the Atari) is:

        +------------------------+      &lt;- top of usable RAM, sp points here
        |          stack         |
        .                        .
        .                        .
        |    free space/heap     |
        +------------------------+      &lt;- __BSS_RUN__ + __BSS_SIZE__
        |           BSS          |
        +------------------------+      &lt;- __BSS_RUN__
        |          DATA          |
        +------------------------+
        |         RODATA         |
        +------------------------+
        |          CODE          |
        |         LOWCODE        |
        |         STARTUP        |
        +------------------------+      &lt;- load address

All stuff written in capital letters is part of your program as generated by
the compiler. All segments with the exception of BSS are part of the program
image generated by the compiler. The BSS contains uninitialized data, so
there's no need to store it in the program image (saves some space). Instead
it is cleared by the startup code, so it contains zeroes when main() is
called.

The stack is set up in high memory, it grows downwards. Between the stack and
the end of the program data (the BSS segment) is free space, which will be
used by the heap. To locate this free space, the heap initialization code
references the BSS segment. To locate the end of the free space, the heap
initialization code uses the stack pointer (which was already set up by the
startup code) and subtracts the maximum stack size as defined in the linker
config.

Please note that most platforms use this setup, but apart from being practial
and used on many other (non 6502 platforms) as well, there is no real reason
for it. If you use your own startup code and config file, you may as well
place the stack below the code segment, change the order of the segments, or
place the heap between program segments. Most parts of the existing runtime
and C library code won't care about such changes, the only exception I know of
is the initialization of the heap. However, since this initialization is
located in exactly one module, you can just replace the module and things
should be ok. There will be a more flexible solution in the future, but as
stated before, it needs an extension of the linker.

Regards


        Uz


-- 
Ullrich von Bassewitz                                  <a href="mailto:uz_at_musoftware.de?Subject=Re:%20[cc65]%20Platform%20specific%20docs">uz_at_musoftware.de</a>
----------------------------------------------------------------------
To unsubscribe from the list send mail to <a href="mailto:majordomo_at_musoftware.de?Subject=Re:%20[cc65]%20Platform%20specific%20docs">majordomo_at_musoftware.de</a> with
the string &quot;unsubscribe cc65&quot; in the body(!) of the mail.
</pre>
<p><!-- body="end" -->
<hr noshade>
<ul>
<!-- next="start" -->
<li><strong>Previous message:</strong> <a href="3674.html">Shawn Jefferson: "Re: [cc65] Platform specific docs"</a>
<li><strong>In reply to:</strong> <a href="3674.html">Shawn Jefferson: "Re: [cc65] Platform specific docs"</a>
<!-- nextthread="start" -->
<li><strong>Next in thread:</strong> <a href="3676.html">Shawn Jefferson: "Re: [cc65] Platform specific docs"</a>
<li><strong>Next in thread:</strong> <a href="../2003-09/3446.html">Groepaz: "Re: [cc65] Platform specific docs"</a>
<!-- reply="end" -->
</ul>
<div align="center">
<table border="2" width="100%">
<tr>
<th><a href="date.html">Date view</a></th>
<th><a href="index.html">Thread view</a></th>
<th><a href="subject.html">Subject view</a></th>
</tr>
</table>
</div>
<!-- trailer="footer" -->
<p>
<small>
<em>
This archive was generated by <a href="http://www.hypermail.org/">hypermail 2.1.3</a> 
: <em>2003-10-28 21:05:54 CET</em>
</em>
</small>
</body>
</html>
