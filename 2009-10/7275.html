<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="hypermail 2.1.8, see http://www.hypermail.org/" />
<title>cc65 mailing list archive: Re: [cc65] .global vs .export vs what</title>
<meta name="Author" content="Groepaz (groepaz1gmx.net)" />
<meta name="Subject" content="Re: [cc65] .global vs .export vs what i really need :)" />
<meta name="Date" content="2009-10-24" />
<style type="text/css">
/*<![CDATA[*/
/* To be incorporated in the main stylesheet, don't code it in hypermail! */
body {color: black; background: #ffffff}
dfn {font-weight: bold;}
pre { background-color:inherit;}
.head { border-bottom:1px solid black;}
.foot { border-top:1px solid black;}
th {font-style:italic;}
table { margin-left:2em;}map ul {list-style:none;}
#mid { font-size:0.9em;}
#received { float:right;}
address { font-style:inherit ;}
/*]]>*/
.quotelev1 {color : #990099}
.quotelev2 {color : #ff7700}
.quotelev3 {color : #007799}
.quotelev4 {color : #95c500}
</style>
</head>
<body>
<div class="head">
<h1>Re: [cc65] .global vs .export vs what i really need :)</h1>
<!-- received="Sat Oct 24 23:21:42 2009" -->
<!-- isoreceived="20091024212142" -->
<!-- sent="Sat, 24 Oct 2009 23:22:25 +0200" -->
<!-- isosent="20091024212225" -->
<!-- name="Groepaz" -->
<!-- email="groepaz1gmx.net" -->
<!-- subject="Re: [cc65] .global vs .export vs what i really need :)" -->
<!-- id="200910242322.26591.groepaz@gmx.net" -->
<!-- charset="utf-8" -->
<!-- inreplyto="20091024183541.GA27438&#64;trixie.musoftware.de" -->
<!-- expires="-1" -->
<map id="navbar" name="navbar">
<ul class="links">
<li>
<dfn>This message</dfn>:
[ <a href="#start" name="options1" id="options1" tabindex="1">Message body</a> ]
 [ <a href="#options2">More options</a> ]
</li>
<li>
<dfn>Related messages</dfn>:
<!-- unext="start" -->
[ <a href="7276.html" title="Groepaz: &quot;Re: [cc65] .global vs .export vs what i really need :)&quot;">Next message</a> ]
[ <a href="7274.html" title="Ullrich von Bassewitz: &quot;Re: [cc65] ca65 --create-dep&quot;">Previous message</a> ]
[ <a href="7272.html" title="Ullrich von Bassewitz: &quot;Re: [cc65] .global vs .export vs what i really need :)&quot;">In reply to</a> ]
<!-- unextthread="start" -->
 [ <a href="7276.html" title="Groepaz: &quot;Re: [cc65] .global vs .export vs what i really need :)&quot;">Next in thread</a> ]
 [ <a href="#replies">Replies</a> ]
<!-- ureply="end" -->
</li>
</ul>
</map>
</div>
<!-- body="start" -->
<div class="mail">
<address class="headers">
<span id="from">
<dfn>From</dfn>: Groepaz &lt;<a href="mailto:groepaz1gmx.net?Subject=Re:%20[cc65]%20.global%20vs%20.export%20vs%20what%20i%20really%20need%20:)">groepaz1gmx.net</a>&gt;
</span><br />
<span id="date"><dfn>Date</dfn>: 2009-10-24 23:22:25</span><br />
</address>
<pre id="body">
<a name="start" accesskey="j" id="start"></a>On Samstag 24 Oktober 2009, Ullrich von Bassewitz wrote:
&gt; On Fri, Oct 23, 2009 at 09:42:27PM +0200, Groepaz wrote:
&gt; &gt; the optimizer moves around small pieces of code, which means that often
&gt; &gt; labels will be referenced from a totally different place as before. the
&gt; &gt; consequence is that i need to tell the assembler somehow that this symbol
&gt; &gt; exists, ie i need to add the equivalent of a c prototype kindof.
&gt;
&gt; Why? For code labels, forwards should work without a problem.
&gt;
&gt; &gt; mmh, since .global is already used, maybe you can add something
&gt; &gt; like .proto / .protozp that does this? or is there infact a way to achive
&gt; &gt; this with the existing stuff and i am just too dumb to read the docs? :)
&gt;
&gt; Maybe you can explain why there is a problem. If a label isn't know when it
&gt; is encountered, the assembler assumes absolute addressing and fixes the
&gt; correct value once it gets known.

ok well then.... its probably a bug in the assembler =)

i have uploaded two files: <a href="http://hitmen.c02.at/temp/easyprog.all.s">http://hitmen.c02.at/temp/easyprog.all.s</a> ... this 
is the full code in one file, this file assembles and links (and works) fine.

<a href="http://hitmen.c02.at/temp/easyprog.opt.s">http://hitmen.c02.at/temp/easyprog.opt.s</a> is the optimized version, which gives 
the following errors:

Unresolved external `X00XL00F4X00X' referenced in:
  obj/easyprog.opt.s(483)
Unresolved external `X01XL00B6X01X' referenced in:
  obj/easyprog.opt.s(982)
Unresolved external `X03XL00DAX03X' referenced in:
  obj/easyprog.opt.s(722)
Unresolved external `X03XL00F6X03X' referenced in:
  obj/easyprog.opt.s(403)
  obj/easyprog.opt.s(502)
Unresolved external `X03XL0143X03X' referenced in:
  obj/easyprog.opt.s(582)
Unresolved external `X03XL0145X03X' referenced in:
  obj/easyprog.opt.s(868)
  obj/easyprog.opt.s(944)
Unresolved external `X03XL0199X03X' referenced in:
  obj/easyprog.opt.s(330)
  obj/easyprog.opt.s(606)
Unresolved external `X03XL019AX03X' referenced in:
  obj/easyprog.opt.s(785)
Unresolved external `X03XL019EX03X' referenced in:
  obj/easyprog.opt.s(1309)
Unresolved external `X03XL019FX03X' referenced in:
  obj/easyprog.opt.s(1311)
Unresolved external `X03XL01A1X03X' referenced in:
  obj/easyprog.opt.s(858)
Unresolved external `X06XL002CX06X' referenced in:
  obj/easyprog.opt.s(754)
  obj/easyprog.opt.s(1278)
Unresolved external `X06XL002DX06X' referenced in:
  obj/easyprog.opt.s(799)
Unresolved external `X06XL002EX06X' referenced in:
  obj/easyprog.opt.s(672)
Unresolved external `X06XL008EX06X' referenced in:
  obj/easyprog.opt.s(747)
  obj/easyprog.opt.s(1161)
  obj/easyprog.opt.s(1324)
Unresolved external `X06XL010BX06X' referenced in:
  obj/easyprog.opt.s(467)
Unresolved external `X06XL0146X06X' referenced in:
  obj/easyprog.opt.s(350)
Unresolved external `X06XL0149X06X' referenced in:
  obj/easyprog.opt.s(1015)
Unresolved external `X07XL0007X07X' referenced in:
  obj/easyprog.opt.s(1171)
Unresolved external `X09XL002BX09X' referenced in:
  obj/easyprog.opt.s(1242)
Unresolved external `X09XL002CX09X' referenced in:
  obj/easyprog.opt.s(1244)
Unresolved external `X10XL002AX10X' referenced in:
  obj/easyprog.opt.s(629)
Unresolved external `X10XL00CFX10X' referenced in:
  obj/easyprog.opt.s(1183)
Unresolved external `X10XL00D0X10X' referenced in:
  obj/easyprog.opt.s(1185)
Unresolved external `X10XL00D2X10X' referenced in:
  obj/easyprog.opt.s(1190)
Unresolved external `X10XL0111X10X' referenced in:
  obj/easyprog.opt.s(732)
ld65: Error: 26 unresolved external(s) found - cannot create output file

(this file assembles and works fine when adding .exports as &quot;prototypes&quot; for 
those labels manually)

the fact that in this source those labels are all in a bss section (i think) 
is a bit misleading, it also happens with labels in code (i have worked 
around this in this test by prefixing some of them). to me it looks like 
segments have to do with the problem though. here is a stripped down snippet 
that still gives an error:

	.proc	easyprog_opt_s0139
	sta	X00XL00F4X00X
	stx	X00XL00F4X00X+$01
	rts
	.endproc


	.proc	X00X_loadEAPIX00X 
	.segment	&quot;BSS&quot;
X00XL00F3X00X:
	.res	$01,$00
X00XL00F4X00X:
	.res	$02,$00
	.segment	&quot;CODE&quot;
	lda	#$01
	.endproc

$ cl65 -o bugtest bugtest.s
bugtest.s(5): Error: Symbol `X00XL00F4X00X' is undefined

now odd enough, when i add the .export X00XL00F4X00X at the top of the file, i 
do still get an error:

$ cl65 -o bugtest bugtest.s
bugtest.s(2): Error: Exported symbol `X00XL00F4X00X' was never defined

now i change the .export to .global ... and i get a similar error, but now 
from the linker

$ cl65 -o bugtest bugtest.s
ld65: Warning: [builtin config](6): Segment `STARTUP' does not exist
ld65: Warning: [builtin config](12): Segment `ZPSAVE' does not exist
Unresolved external `X00XL00F4X00X' referenced in:
  bugtest.s(2)
ld65: Error: 1 unresolved external(s) found - cannot create output file

and when i also put another .global directly before the label, THEN it finally 
compiles - but now the symbol is exported from the resulting object file, 
which it shouldnt:

$ od65 --dump-exports bugtest.o
bugtest.o:
  Exports:
    Count:                          1
    Index:                          0
      Type:                      0x30  (EXP_EXPR)
      Address size:              0x02  (absolute)
      Name:           &quot;X00XL00F4X00X&quot;


i am really confused now =) the whole import/export stuff seems to be mangled 
with the namespaces of procs (and possibly other things) if i interpret this 
test correctly. however, even this:

	.import X00XL00F4X00X

	.proc	easyprog_opt_s0139
	sta	X00XL00F4X00X
	stx	X00XL00F4X00X+$01
	rts
	.endproc


	.proc	X00X_loadEAPIX00X 
	.segment	&quot;BSS&quot;
X00XL00F3X00X:
	.res	$01,$00
	.export X00XL00F4X00X
X00XL00F4X00X:
	.res	$02,$00
	.segment	&quot;CODE&quot;
	lda	#$01
	.endproc

doesnt give the wanted result (the symbol is still exported from the object 
file).

.... help :)


-- 

<a href="http://www.hitmen-console.org">http://www.hitmen-console.org</a>    <a href="http://magicdisk.untergrund.net">http://magicdisk.untergrund.net</a>
<a href="http://www.pokefinder.org">http://www.pokefinder.org</a>        <a href="http://ftp.pokefinder.org">http://ftp.pokefinder.org</a>

Unser Schorf soll Döner werden!

----------------------------------------------------------------------
To unsubscribe from the list send mail to majordomo&#64;musoftware&#46;<!--nospam-->de with
the string &quot;unsubscribe cc65&quot; in the body(!) of the mail.
</pre>
<span id="received"><dfn>Received on</dfn> Sat Oct 24 23:21:42 2009</span>
</div>
<!-- body="end" -->
<div class="foot">
<map id="navbarfoot" name="navbarfoot" title="Related messages">
<ul class="links">
<li><dfn>This message</dfn>: [ <a href="#start">Message body</a> ]</li>
<!-- lnext="start" -->
<li><dfn>Next message</dfn>: <a href="7276.html" title="Next message in the list">Groepaz: "Re: [cc65] .global vs .export vs what i really need :)"</a></li>
<li><dfn>Previous message</dfn>: <a href="7274.html" title="Previous message in the list">Ullrich von Bassewitz: "Re: [cc65] ca65 --create-dep"</a></li>
<li><dfn>In reply to</dfn>: <a href="7272.html" title="Message to which this message replies">Ullrich von Bassewitz: "Re: [cc65] .global vs .export vs what i really need :)"</a></li>
<!-- lnextthread="start" -->
<li><dfn>Next in thread</dfn>: <a href="7276.html" title="Next message in this discussion thread">Groepaz: "Re: [cc65] .global vs .export vs what i really need :)"</a></li>
<li><a name="replies" id="replies"></a><dfn>Reply</dfn>:  <a href="7276.html" title="Message sent in reply to this message">Groepaz: "Re: [cc65] .global vs .export vs what i really need :)"</a></li>
<li><dfn>Reply</dfn>:  <a href="7313.html" title="Message sent in reply to this message">Ullrich von Bassewitz: "Re: [cc65] .global vs .export vs what i really need :)"</a></li>
<!-- lreply="end" -->
</ul>
<ul class="links">
<li><a name="options2" id="options2"></a><dfn>Contemporary messages sorted</dfn>: [ <a href="date.html#7275" title="Contemporary messages by date">By Date</a> ] [ <a href="index.html#7275" title="Contemporary discussion threads">By Thread</a> ] [ <a href="subject.html#7275" title="Contemporary messages by subject">By Subject</a> ]</ul>
</map>
</div>
<!-- trailer="footer" -->
<p><small><em>
This archive was generated by <a href="http://www.hypermail.org/">hypermail 2.1.8</a> 
: 2009-10-24 23:21:45 CEST
</em></small></p>
</body>
</html>
