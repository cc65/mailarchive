<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<meta name="generator" content="hypermail 2.1.8, see http://www.hypermail.org/" />
<title>cc65 mailing list archive: Re: [cc65] linking to o65</title>
<meta name="Author" content="Gábor Lénárt (lgb1lgb.hu)" />
<meta name="Subject" content="Re: [cc65] linking to o65" />
<meta name="Date" content="2012-01-19" />
<style type="text/css">
/*<![CDATA[*/
/* To be incorporated in the main stylesheet, don't code it in hypermail! */
body {color: black; background: #ffffff}
dfn {font-weight: bold;}
pre { background-color:inherit;}
.head { border-bottom:1px solid black;}
.foot { border-top:1px solid black;}
th {font-style:italic;}
table { margin-left:2em;}map ul {list-style:none;}
#mid { font-size:0.9em;}
#received { float:right;}
address { font-style:inherit ;}
/*]]>*/
.quotelev1 {color : #990099}
.quotelev2 {color : #ff7700}
.quotelev3 {color : #007799}
.quotelev4 {color : #95c500}
</style>
</head>
<body>
<div class="head">
<h1>Re: [cc65] linking to o65</h1>
<!-- received="Thu Jan 19 17:02:24 2012" -->
<!-- isoreceived="20120119160224" -->
<!-- sent="Thu, 19 Jan 2012 17:02:15 +0100" -->
<!-- isosent="20120119160215" -->
<!-- name="Gábor Lénárt" -->
<!-- email="lgb1lgb.hu" -->
<!-- subject="Re: [cc65] linking to o65" -->
<!-- id="20120119160215.GE16578@vega.lgb.hu" -->
<!-- charset="iso-8859-1" -->
<!-- inreplyto="20120119145259.GB20038&#64;trixie.musoftware.de" -->
<!-- expires="-1" -->
<map id="navbar" name="navbar">
<ul class="links">
<li>
<dfn>This message</dfn>:
[ <a href="#start" name="options1" id="options1" tabindex="1">Message body</a> ]
 [ <a href="#options2">More options</a> ]
</li>
<li>
<dfn>Related messages</dfn>:
<!-- unext="start" -->
[ <a href="9904.html" title="Andreas Rückert: &quot;Re: [cc65] Macros in inline assembler&quot;">Next message</a> ]
[ <a href="9902.html" title="Oliver Schmidt: &quot;Re: [cc65] Macros in inline assembler&quot;">Previous message</a> ]
[ <a href="9899.html" title="Ullrich von Bassewitz: &quot;Re: [cc65] linking to o65&quot;">In reply to</a> ]
<!-- unextthread="start" -->
 [ <a href="9910.html" title="Ullrich von Bassewitz: &quot;Re: [cc65] linking to o65&quot;">Next in thread</a> ]
 [ <a href="#replies">Replies</a> ]
<!-- ureply="end" -->
</li>
</ul>
</map>
</div>
<!-- body="start" -->
<div class="mail">
<address class="headers">
<span id="from">
<dfn>From</dfn>: Gábor Lénárt &lt;<a href="mailto:lgb1lgb.hu?Subject=Re:%20[cc65]%20linking%20to%20o65">lgb1lgb.hu</a>&gt;
</span><br />
<span id="date"><dfn>Date</dfn>: 2012-01-19 17:02:15</span><br />
</address>
<pre id="body">
<a name="start" accesskey="j" id="start"></a>Hi,

On Thu, Jan 19, 2012 at 03:52:59PM +0100, Ullrich von Bassewitz wrote:
&gt; 
&gt; Hi!
&gt; 
&gt; On Thu, Jan 19, 2012 at 09:48:35AM +0100, Gábor Lénárt wrote:
&gt; &gt; * I want to link into o65 object format rather than a &quot;ready-to-run&quot; prg.
&gt; &gt; * I have some undefined symbol, which should be not a problem: the
&gt; &gt;   software which loads the o65 (as from external file, from disk, for
&gt; &gt;   example) would provide the missing information (common routines referenced
&gt; &gt;   by my programs would be implemented by the &quot;loader&quot;)
&gt; &gt; * Can I set up some o65 specific header information (cpu type, alignment,
&gt; &gt;   object type, ? If not, it's maybe possible that I write an utility which
&gt; &gt;   &quot;modifies&quot; the o65 generated by cc65, but it's not so elegant anyway.
&gt; &gt;
&gt; &gt; It's not clear for me currently, how I should do this, can someone help?
&gt; 
&gt; ld65 is mostly tailored for generating o65 executables, not o65 object files.

Indeed, I used bad notion, I meant o65 executable (however from the point of
view of the format, the difference is not so big).

Thanks for the answer, I guess I start with the lunix target (of ld65), as
it seems ld65 generates o65 for that, so the situation can be somewhat
similar.

Btw, I am not really sure if it's sane what I want. If I compile a C program
with cc65 I can see references like these in the generated asm:

jsr     pushax
jsr     incax2
jsr     _printf

I would like not only _printf() call is implemented &quot;by my own&quot; but also
internal stuffs like pushax and incax2. I have the hope with this that
loaded programs (in o65 format) can be as small as possible, since the
described functionality is implemented by the &quot;loader&quot; and anyway they are
common in all code, so why would I store them again and agin in every
programs? Just for information: my ultimate goal is to write some &quot;hobby OS&quot;
by my own (for DTV, where there is enough RAM, relocatable stack/zero page,
etc, so a multitask OS can be implemented more easily than with a stock C64
for example), even with multitasking. The &quot;loader stuff&quot; is just the first
step to test some of my ideas, no multitask, and other similar features yet.

However, it's possible that it would be faster and more easy to implement
with fixed locations of pushax,incax,_printf etc in the loader code, so I
should not do the linking with many string comparation operations, but
providing eg &quot;pushax&quot; as a fixed address before running ld65. Then I would
use o65 format just for being relocatable code, so the program itself can be
loaded to any memory address which will be useful if there are more
concurent running tasks in the (far?) future.

What made me a bit unsure: how &quot;stable&quot; the &quot;internal ABI/API&quot;? I mean about
pushax, etc. Is it common to have a new function like this with a new cc65
version? Since if I implement those by my own, I will have problem with a
newer cc65 if it uses things differently, or new stuff is introduced etc.

&gt; You didn't specify which type you're targeting. And, it is tested mostly with
&gt; cc65 modules. So while there is some support for other output, it is rarely
&gt; used and may therefore be untested/non working.

Well, if lunix target works well, it will be ok, I can create a
configuration similar to the lunix starting with the linker config file
dumped with ld65 (ld65 --dump-config lunix) and modified for my needs. I guess :)

&gt; Regarding imports: Specifying the o65 imports in the linker config allows the
&gt; linker to do error checking. Treating every unknown symbol as import might be
&gt; possible but delays the error to the point where the executable is run.

That's true. However most OSes work this way, it's possible with eg Linux
that an ELF binary refeers for a symbol that dynamic linker cannot resolve
at the time when you want to execute it.

&gt; There's also a reason not to rely on imports: The string table for the names
&gt; of the symbols may get rather big. This is the reason why loadable drivers
&gt; (which a in o65 format) use a jump table instead of imports by name.

That's an important point. Just I had the dream that there can be an OS
which has programs compatible with any computers which can run that OS and
use the same CPU, but the exact type of the computer is not important. By
providing fixed addresses instead of linkable stuffs (given by its names)
there is a stricter need, maybe an architecture can't provide for me too
well to place the OS code to the very same address I have it on another kind
of machine. In nutshell: I wanted to create something which is depends on
the CPU only, nothing more, if the CPU is compatible with 6502 (and the OS
is ported for that computer of course) it will run, no need a single bit of
modification.
 
&gt; Header information (apart from 16/32 bit which is small/large in the config)
&gt; can currently not be set. The functions are there, but there are no matching
&gt; attributes in the config file.
&gt; 
&gt; So as a summary: The currently available features are probably not enough for
&gt; what you want to do. Most of them can be easily added. But since o65 usage has
&gt; been rare, I would prefer to add just the things that are really necessary.

I see. I would not use the .o format of cc65 directly as I guess it's not
designed for this purpose (maybe not so easy to handle on a pre-PC era based
system with limited resources, and also it's for internal use, as far as I
can guess it's not even always &quot;stable&quot; in the sense that the format can
change, while o65 is quite simple and has a well-defined structure by a
documentation. If I am wrong, execuse me).

- Gábor
----------------------------------------------------------------------
To unsubscribe from the list send mail to majordomo&#64;musoftware&#46;<!--nospam-->de with
the string &quot;unsubscribe cc65&quot; in the body(!) of the mail.
</pre>
<span id="received"><dfn>Received on</dfn> Thu Jan 19 17:02:24 2012</span>
</div>
<!-- body="end" -->
<div class="foot">
<map id="navbarfoot" name="navbarfoot" title="Related messages">
<ul class="links">
<li><dfn>This message</dfn>: [ <a href="#start">Message body</a> ]</li>
<!-- lnext="start" -->
<li><dfn>Next message</dfn>: <a href="9904.html" title="Next message in the list">Andreas Rückert: "Re: [cc65] Macros in inline assembler"</a></li>
<li><dfn>Previous message</dfn>: <a href="9902.html" title="Previous message in the list">Oliver Schmidt: "Re: [cc65] Macros in inline assembler"</a></li>
<li><dfn>In reply to</dfn>: <a href="9899.html" title="Message to which this message replies">Ullrich von Bassewitz: "Re: [cc65] linking to o65"</a></li>
<!-- lnextthread="start" -->
<li><dfn>Next in thread</dfn>: <a href="9910.html" title="Next message in this discussion thread">Ullrich von Bassewitz: "Re: [cc65] linking to o65"</a></li>
<li><a name="replies" id="replies"></a><dfn>Reply</dfn>:  <a href="9910.html" title="Message sent in reply to this message">Ullrich von Bassewitz: "Re: [cc65] linking to o65"</a></li>
<!-- lreply="end" -->
</ul>
<ul class="links">
<li><a name="options2" id="options2"></a><dfn>Contemporary messages sorted</dfn>: [ <a href="date.html#9903" title="Contemporary messages by date">By Date</a> ] [ <a href="index.html#9903" title="Contemporary discussion threads">By Thread</a> ] [ <a href="subject.html#9903" title="Contemporary messages by subject">By Subject</a> ]</ul>
</map>
</div>
<!-- trailer="footer" -->
<p><small><em>
This archive was generated by <a href="http://www.hypermail.org/">hypermail 2.1.8</a> 
: 2012-01-19 17:02:27 CET
</em></small></p>
</body>
</html>
